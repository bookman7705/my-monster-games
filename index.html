<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebXR Markerless AR Example</title>
    <style>
      body { margin: 0; }
      #canvas { display: block; width: 100%; height: 100%; }
    </style>
  </head>
  <body>
    <button id="startButton">Start AR</button>
    <canvas id="canvas"></canvas>

    <script>
      // Initialize WebXR session and AR features
      let xrSession = null;
      let xrViewer = null;

      // Check if WebXR is supported
      if (!navigator.xr) {
        alert("WebXR not supported on this device.");
        throw new Error("WebXR not supported");
      }

      // Start AR session
      document.getElementById("startButton").addEventListener("click", async () => {
        try {
          xrSession = await navigator.xr.requestSession("immersive-ar", {
            requiredFeatures: ["hit-test", "local"]
          });

          xrViewer = new XRViewer({ xrSession });
          await xrViewer.start();
        } catch (error) {
          console.error("Failed to start AR session: ", error);
        }
      });

      // Handle hit testing and surface detection
      class XRViewer {
        constructor(options) {
          this.xrSession = options.xrSession;
          this.xrSession.addEventListener("end", this.onSessionEnd);
        }

        async start() {
          const canvas = document.getElementById("canvas");
          const gl = canvas.getContext("webgl");
          const xrReferenceSpace = await this.xrSession.requestReferenceSpace("local");

          // Create AR hit-test source
          const hitTestSource = await this.xrSession.requestHitTestSource({
            space: xrReferenceSpace,
          });

          // Start rendering loop for WebXR
          this.xrSession.requestAnimationFrame(this.render.bind(this, hitTestSource, gl));
        }

        async render(hitTestSource, gl) {
          const hitTestResults = await hitTestSource.requestHitTest(
            new XRPoint(0, 0),
            this.xrSession.baseLayer.renderState
          );

          if (hitTestResults.length > 0) {
            // Handle surface detection
            const hitPose = hitTestResults[0].getPose(xrReferenceSpace);
            this.placeModelOnSurface(hitPose, gl);
          }

          this.xrSession.requestAnimationFrame(this.render.bind(this, hitTestSource, gl));
        }

        placeModelOnSurface(hitPose, gl) {
          // Implement code to place a 3D model at the detected position
          console.log("Detected Surface:", hitPose);
        }

        onSessionEnd() {
          console.log("AR session ended.");
        }
      }
    </script>
  </body>
</html>
